<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Reanalysis Report</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="reanalysis report_files/libs/clipboard/clipboard.min.js"></script>
<script src="reanalysis report_files/libs/quarto-html/quarto.js"></script>
<script src="reanalysis report_files/libs/quarto-html/popper.min.js"></script>
<script src="reanalysis report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="reanalysis report_files/libs/quarto-html/anchor.min.js"></script>
<link href="reanalysis report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="reanalysis report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="reanalysis report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="reanalysis report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="reanalysis report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#loading-in-the-data-and-necessary-packages" id="toc-loading-in-the-data-and-necessary-packages" class="nav-link active" data-scroll-target="#loading-in-the-data-and-necessary-packages"><span class="header-section-number">1</span> Loading in the Data and Necessary Packages</a></li>
  <li><a href="#creating-the-brsim-function" id="toc-creating-the-brsim-function" class="nav-link" data-scroll-target="#creating-the-brsim-function"><span class="header-section-number">2</span> Creating the <code>BRsim</code> function</a></li>
  <li><a href="#combining-and-subsetting-the-data" id="toc-combining-and-subsetting-the-data" class="nav-link" data-scroll-target="#combining-and-subsetting-the-data"><span class="header-section-number">3</span> Combining and Subsetting the Data</a>
  <ul class="collapse">
  <li><a href="#joining-ceramics-and-coordinates-to-the-main-dataframe" id="toc-joining-ceramics-and-coordinates-to-the-main-dataframe" class="nav-link" data-scroll-target="#joining-ceramics-and-coordinates-to-the-main-dataframe"><span class="header-section-number">3.1</span> Joining ceramics and coordinates to the main dataframe</a></li>
  <li><a href="#filtering-the-dataset" id="toc-filtering-the-dataset" class="nav-link" data-scroll-target="#filtering-the-dataset"><span class="header-section-number">3.2</span> Filtering the dataset</a></li>
  <li><a href="#binning-the-dataset-by-50-year-intervals" id="toc-binning-the-dataset-by-50-year-intervals" class="nav-link" data-scroll-target="#binning-the-dataset-by-50-year-intervals"><span class="header-section-number">3.3</span> Binning the dataset by 50-year intervals</a></li>
  <li><a href="#review-of-descriptive-analyses" id="toc-review-of-descriptive-analyses" class="nav-link" data-scroll-target="#review-of-descriptive-analyses"><span class="header-section-number">3.4</span> Review of Descriptive Analyses</a></li>
  </ul></li>
  <li><a href="#creating-the-1400-1450-similarity-matrix" id="toc-creating-the-1400-1450-similarity-matrix" class="nav-link" data-scroll-target="#creating-the-1400-1450-similarity-matrix"><span class="header-section-number">4</span> Creating the 1400-1450 Similarity Matrix</a></li>
  <li><a href="#making-the-coordinate-matrix" id="toc-making-the-coordinate-matrix" class="nav-link" data-scroll-target="#making-the-coordinate-matrix"><span class="header-section-number">5</span> Making the Coordinate Matrix</a></li>
  <li><a href="#louvain-community-detection" id="toc-louvain-community-detection" class="nav-link" data-scroll-target="#louvain-community-detection"><span class="header-section-number">6</span> Louvain Community Detection</a></li>
  <li><a href="#adjusted-rand-index-for-1400-1450-communities" id="toc-adjusted-rand-index-for-1400-1450-communities" class="nav-link" data-scroll-target="#adjusted-rand-index-for-1400-1450-communities"><span class="header-section-number">7</span> Adjusted Rand Index for 1400-1450 Communities</a></li>
  <li><a href="#prototypical-scales-and-breakpoints" id="toc-prototypical-scales-and-breakpoints" class="nav-link" data-scroll-target="#prototypical-scales-and-breakpoints"><span class="header-section-number">8</span> Prototypical Scales and Breakpoints</a></li>
  <li><a href="#plotting-the-ari-heatmap" id="toc-plotting-the-ari-heatmap" class="nav-link" data-scroll-target="#plotting-the-ari-heatmap"><span class="header-section-number">9</span> Plotting the ARI Heatmap</a></li>
  <li><a href="#final-review-and-summary-of-results" id="toc-final-review-and-summary-of-results" class="nav-link" data-scroll-target="#final-review-and-summary-of-results"><span class="header-section-number">10</span> Final Review and Summary of Results</a>
  <ul class="collapse">
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">10.1</span> Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Reanalysis Report</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In <em>Archaeological networks, community detection, and critical scales of interaction in the U.S. Southwest/Mexican Northwest,</em> Peeples &amp; Bischoff aim to identity what they call critical scales between communities in the SW/NW region. To do this, they use the similarity of ceramic ware styles between sites across distance to determine the bounds of ancient communities.</p>
<p>Breaking this work down into steps, they use a list of SWSN sites, ceramic types, ceramic wares, and UTM coordinates (stored in 3 different .csv files) to subset the periods and sites they’re interested in before conducting Louvain method tests of community detection, creating Rand Indexes for these tests, and determining prototypical scales or breaklines for each test. I’ll be using the <code>attr_all</code> data sheet for coordinates, <code>Ceramic_type_master</code> for ceramic wares, and <code>data_all</code> for the sites and dates.</p>
<p>Peeples &amp; Bischoff aren’t making a claim about whether or not there ARE communities or critical scales for the SW/NW. Instead their conclusions focus about HOW those communities take shape and change over time. In this way, their work reaffirms the usage of their methodologies, the continuity between groups, and where these inevitable spatial relationships change.</p>
<p>Due to the immense scale of producing multiple extremely long matrices per 50-year interval, I couldn’t replicate most of the more intriguing inter-interval tests without wasting dozens of hours on loading in data. Instead of fI focused on reproducing the methodology outlined in the section on Rand Indexes. I would up replicating <strong>the site list’s descriptive data</strong>, the <strong>inferential data around the 1400-1450AD matrix</strong>, and the <strong>visual depicting 1400-1450AD’s Rand Index with breaklines.</strong> To wit, this means I’m attempting to focus in on their conclusions about methodology and the shape of spatial relationships and will sadly have to ignore their most interesting conclusions.</p>
<section id="loading-in-the-data-and-necessary-packages" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="loading-in-the-data-and-necessary-packages"><span class="header-section-number">1</span> Loading in the Data and Necessary Packages</h2>
<p>Prior to loading in the data I downloaded and set up the following packages. Peeples and Bischoff outline <code>:igraph:</code> and <code>:ecp:</code> for their functions explicitly and <code>:sna:</code> and <code>:fossil:</code> by proxy. Other packages like <code>:tidyverse:</code> or <code>:foreach:</code> were necessary for other processes (such as proper looping or piping) as they emerged.</p>
<p>The data was taken from this gitHub repository “<a href="https://github.com/mpeeples2008/CriticalScales" class="uri">https://github.com/mpeeples2008/CriticalScales</a>” and is stored in the data folder of this repository. I’ve loaded the head of some of the basic data to get a grasp on the information.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#necessary libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sna)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ecp)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fossil)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Load data</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/data_all copy.csv"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>ceramic <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/Ceramic_type_master copy.csv"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/attr_all copy.csv"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ceramic)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coords)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-the-brsim-function" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="creating-the-brsim-function"><span class="header-section-number">2</span> Creating the <code>BRsim</code> function</h2>
<p>Before I begin handling the data I loaded in the custom function, <code>:BRsim:</code> which is meant to replicate the Brainerd-Robinson measure of similarity. Peeples and Bischoff provide the following equation;</p>
<p><code>S = 2-sum(CeramicWare)*proportion of Wares at site A - proportion of Wares at site B / 2</code>.</p>
<p>This would have been a pain to try and reconstruct and I did produce some early drafts; however, I found a custom-made function from this link; <a href="https://cainarchaeology.weebly.com/r-function-for-brainerd-robinson-similarity-coefficient.html" class="uri">https://cainarchaeology.weebly.com/r-function-for-brainerd-robinson-similarity-coefficient.html</a>. I adapted this lightly to produce a high-quality function</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#BR similarity matrix function #adapted from someone elses function</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>BRsim <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">correction =</span> <span class="cn">TRUE</span>, <span class="at">rescale =</span> <span class="cn">TRUE</span>, <span class="at">ncores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(ncores)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  rd <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  rownames_x <span class="ot">&lt;-</span> <span class="fu">rownames</span>(x)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  norm_x <span class="ot">&lt;-</span> <span class="fu">sweep</span>(x, <span class="dv">1</span>, <span class="fu">rowSums</span>(x), <span class="st">"/"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  sim_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> rd, <span class="at">ncol =</span> rd)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(sim_matrix) <span class="ot">&lt;-</span> rownames_x</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sim_matrix) <span class="ot">&lt;-</span> rownames_x</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  row_pairs <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">s1 =</span> <span class="dv">1</span><span class="sc">:</span>rd, <span class="at">s2 =</span> <span class="dv">1</span><span class="sc">:</span>rd)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(row_pairs), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    s1 <span class="ot">&lt;-</span> row_pairs[i, <span class="dv">1</span>]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    s2 <span class="ot">&lt;-</span> row_pairs[i, <span class="dv">2</span>]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">abs</span>(norm_x[s1, ] <span class="sc">-</span> norm_x[s2, ])</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    sim_score <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="fu">sum</span>(diff) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (correction) {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      zero_a <span class="ot">&lt;-</span> <span class="fu">sum</span>(x[s1, ] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      zero_b <span class="ot">&lt;-</span> <span class="fu">sum</span>(x[s2, ] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      joint_zero <span class="ot">&lt;-</span> <span class="fu">sum</span>(x[s1, ] <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> x[s2, ] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      divisor <span class="ot">&lt;-</span> <span class="cf">if</span> (zero_a <span class="sc">==</span> zero_b) <span class="dv">1</span> <span class="cf">else</span> <span class="fu">max</span>(zero_a, zero_b) <span class="sc">-</span> joint_zero <span class="sc">+</span> <span class="fl">0.5</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      sim_score <span class="ot">&lt;-</span> sim_score <span class="sc">/</span> divisor</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    sim_score <span class="ot">&lt;-</span> <span class="cf">if</span> (rescale) sim_score <span class="cf">else</span> sim_score <span class="sc">*</span> <span class="dv">200</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(s1, s2, <span class="fu">round</span>(sim_score, <span class="dv">3</span>))</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)) {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    s1 <span class="ot">&lt;-</span> results[i, <span class="dv">1</span>]</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    s2 <span class="ot">&lt;-</span> results[i, <span class="dv">2</span>]</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    sim <span class="ot">&lt;-</span> results[i, <span class="dv">3</span>]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    sim_matrix[s1, s2] <span class="ot">&lt;-</span> sim</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  sim_matrix[<span class="fu">lower.tri</span>(sim_matrix)] <span class="ot">&lt;-</span> <span class="fu">t</span>(sim_matrix)[<span class="fu">lower.tri</span>(sim_matrix)]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cl)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sim_matrix)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="combining-and-subsetting-the-data" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="combining-and-subsetting-the-data"><span class="header-section-number">3</span> Combining and Subsetting the Data</h2>
<p>After loading in the data, packages, and creating a custom simulation function, my next task was to produce the descriptive statistics mentioned in the article. For this, I had to subset the data according to their specifications. They provided the following terms;</p>
<p><em>“we use data from a set of 1,790 settlements across the study area dating between 1000 and 1450 CE. The settlements selected are <strong>limited to those with at least 10 rooms and 30 systematically identified painted ceramic sherds</strong> (see Mills et al.&nbsp;2013: Supplemental Materials for a discussion of the selection of sample size cut offs).”</em></p>
<section id="joining-ceramics-and-coordinates-to-the-main-dataframe" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="joining-ceramics-and-coordinates-to-the-main-dataframe"><span class="header-section-number">3.1</span> Joining ceramics and coordinates to the main dataframe</h3>
<p>First, I converted <code>SWSN_Type</code> and <code>SWSN_Site</code> to just <code>Type</code> and <code>Site</code> in the <code>ceramic</code> and <code>coords</code> datasets respectively. This allowed an easy <code>left_join()</code> that brought the relevant data (<code>Ware</code>, <code>EASTING</code>, and <code>NORTHING</code>) into the main dataset.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Clean and join to main dataframe</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dj <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ceramic <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Type =</span> SWSN_Type) <span class="sc">|&gt;</span> <span class="fu">select</span>(Type, <span class="at">Ware =</span> SWSN_Ware), <span class="at">by =</span> <span class="st">"Type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(coords <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Site =</span> SWSN_Site) <span class="sc">|&gt;</span> <span class="fu">select</span>(Site, EASTING, NORTHING), <span class="at">by =</span> <span class="st">"Site"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="filtering-the-dataset" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="filtering-the-dataset"><span class="header-section-number">3.2</span> Filtering the dataset</h3>
<p>From there, the dataset had to be filtered to only include sites with at least 30 painted sherds dating between 1000 and 1450. What made this difficult is that each site wasn’t recorded as a whole unit, instead each instance of a ceramic type at a site was recorded. I tried multiple different paths to filtering by site but this way seemed to work the best but is perhaps, a little janky.</p>
<p>This way I created a temporary tibble with a column indicating if size is equal to or greater than 30 for a summarized count by <code>Site</code> and then I appended that column to the main data frame and filtered the new joined data frame by the indicative column. I then deleted the column as it was useless.</p>
<p><strong>Important Note:</strong> In their original text they don’t say explicitly that they sorted by <code>cyberSW == 1</code>; however, all of their sites had to be positioned onto cyberSW in order to be mapped and other files reference cyberSW. Due to this, I thought it was best to filter out any site that didn’t have a column indicating corresponding information in the cyberSW database (the purpose of the <code>cyberSW</code> column in <code>"data_all"</code>)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Filter by connection to cyberSW, at least 30 painted sherds, and between 1000 and 1450</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> dj <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cyberSW <span class="sc">==</span> <span class="dv">1</span>, painted <span class="sc">==</span> <span class="dv">1</span>, Begin <span class="sc">&gt;=</span> <span class="dv">1000</span>, End <span class="sc">&lt;=</span> <span class="dv">1450</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Site) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">True_Count =</span> <span class="fu">sum</span>(Count)) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">remove =</span> <span class="fu">if_else</span>(True_Count <span class="sc">&gt;=</span> <span class="dv">30</span>, <span class="st">"1"</span>, <span class="st">"0"</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>dj2 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(temp <span class="sc">|&gt;</span> <span class="fu">select</span>(Site, remove), <span class="at">by =</span> <span class="st">"Site"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(remove <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>remove)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dj2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="binning-the-dataset-by-50-year-intervals" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="binning-the-dataset-by-50-year-intervals"><span class="header-section-number">3.3</span> Binning the dataset by 50-year intervals</h3>
<p>Finally, I binned the dataset into nine 50-year intervals stretching from 1000 to 1450 (although technically 1449) to follow what Peeples and Bischoff outline in their paper.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Binning temporal intervals</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> dj2 <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bin_starts =</span> <span class="fu">list</span>(<span class="fu">seq</span>(<span class="fu">floor</span>(Begin <span class="sc">/</span> <span class="dv">50</span>) <span class="sc">*</span> <span class="dv">50</span>, <span class="fu">floor</span>(End <span class="sc">/</span> <span class="dv">50</span>) <span class="sc">*</span> <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">50</span>))) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(bin_starts) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bin_end =</span> bin_starts <span class="sc">+</span> <span class="dv">49</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">overlap_start =</span> <span class="fu">pmax</span>(Begin, bin_starts),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">overlap_end =</span> <span class="fu">pmin</span>(End, bin_end),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">overlap_years =</span> overlap_end <span class="sc">-</span> overlap_start <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(overlap_years <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">interval =</span> <span class="fu">paste0</span>(bin_starts, <span class="st">"-"</span>, bin_end)) <span class="sc">|&gt;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>overlap_start, <span class="sc">-</span>overlap_end, <span class="sc">-</span>overlap_years) <span class="sc">|&gt;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="review-of-descriptive-analyses" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="review-of-descriptive-analyses"><span class="header-section-number">3.4</span> Review of Descriptive Analyses</h3>
<p>Comparing to the original numbers given <em>“1790 sites…..1100+ ceramic types”</em> my dataset looks largely similar, but isn’t completely similar. My types fall in line - with 1156 ceramic types in the base data set and 295 in my subsetted data set. Its my analysis of <code>Sites</code> that seem to provide odd information. While only off by a small margin sites, I have 24 sites fewer than Peeples and Bischoff. This is probably from one of three sources or some combination;</p>
<ul>
<li><p>A - this could be due to my inclusion of filtering by <code>cyberSW == 1</code> but in my own workflow I found that that didn’t provide 1790 either. So it’s possible there was something they mentioned in passing or not at all that explains how they handled <code>cyberSW</code></p></li>
<li><p>B - there was one variable I was completely unable to see in the data - <strong>number of rooms per site.</strong> No column in <code>"data_all"</code>, <code>"Ceramic_type_master"</code>, and <code>"attr_all"</code> seems to refer to this. I’m not sure how to include this or how this would lead to a <em>higher</em> number in my final subset.</p></li>
<li><p>C - they used a method called Uniform Probability Density Analysis; outlined below. As you can see, this method is very complex and would have required a giant series of loops over thousands of sites that broke my computer every time I attempted to do it. I admit my own loops were likely not as elegant but any and all R literature I could find on this was produced by the authors - although for a prior article. I used this work to inspire later code (referenced in <strong>Louvain Community Detection</strong>) however, it felt like cheating to rip out the text they developed on UPDA. Nonetheless, this likely influenced the results.</p>
<ul>
<li><em>entails combining information on the chronological ranges associated with specific ceramic types with type frequency data to generate a model of the probability that a site was occupied or that a sherd was deposited in any given year. Briefly, every ceramic type present at a site is modeled using a uniform distribution representing the production dates for that type in the literature and then each distribution is multiplied by the frequency of that type in the assemblage. Data across all types are then summed to generate a composite prior distribution. In addition to this a modified conditional distribution is then calculated which models the overlaps among type dates for multiple types to estimate the most likely interval of deposition for each type (assuming that intervals when multiple types were present are more likely than intervals when just a single type was present). The prior and conditional distributions are finally multiplied to create a posterior distribution which accounts for both the original uniform distribution and the conditional model which prioritizes overlaps in date ranges for each type.</em></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">##descriptive analysis</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(df<span class="sc">$</span>Site)) <span class="co">#1766</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>Type)) <span class="co">#over 1156 gets culled down to</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(df<span class="sc">$</span>Type)) <span class="co">#295</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="do">###these align closely with what was described in the article; however, the sites are off by 24. </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">###im not entirely certain, but it could relate to the room-size variable that wasn't on the dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="creating-the-1400-1450-similarity-matrix" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="creating-the-1400-1450-similarity-matrix"><span class="header-section-number">4</span> Creating the 1400-1450 Similarity Matrix</h2>
<p>Before we can properly run the matrix of similarity, we have to subset the data one last time and rearrange it so that the matrix can function properly. <code>BRsim</code> was returning errors if <code>d1400</code> wasn’t structured completely numerically and recombined the columns to represent the counts of all Wares found in the data and rows to be the sites felt more logical, especially as I was visualizing and working with the resulting tables.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Building data for 1400–1449 interval</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>d1400 <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(interval <span class="sc">==</span> <span class="st">"1400-1449"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Site, Ware) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wareCount =</span> <span class="fu">sum</span>(Count), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Ware, <span class="at">values_from =</span> wareCount, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"Site"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we run the <code>BRsim</code> function. This will produce a matrix of comparisons between each site pair looking at each site in the pair’s proportion of each ceramic ware and then comparing that to the other site’s proportion and the total count. Dividing by two produces a range from 0 (no similarity) and 1 (perfect similarity).<br>
<br>
<strong>WARNING:</strong> This takes a good while to load. I’ll try to upload a saved version alongside the .qmd in the repo but if not, just prepare to waste an hour or so on this.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Run similarity test on the subsetted data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sim1400 <span class="ot">&lt;-</span> <span class="fu">BRsim</span>(d1400)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="making-the-coordinate-matrix" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="making-the-coordinate-matrix"><span class="header-section-number">5</span> Making the Coordinate Matrix</h2>
<p>Next, we have to compare the similarity matrix to a matrix of distances between those same site pairs. For that, I drew out the UTM coordinates from <code>df</code> and then converted them into a matrix called <code>coordmatrix</code>. I then manually set the row names and column names to be <code>Site</code> because otherwise it threw off later combinations.</p>
<p>I then had to run an <code>intersect()</code> between the rownames of <code>sim1400</code> and <code>coordmatrix</code> to get a list of sites that show up in both and then filtered by those sites. Otherwise these matrices would produce different sized results and couldn’t be combined for the Louvain method.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create the distance matrix</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>coord1400 <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">filter</span>(interval <span class="sc">==</span> <span class="st">"1400-1449"</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(Site, EASTING, NORTHING) <span class="sc">|&gt;</span> <span class="fu">distinct</span>()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>coordmatrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(coord1400[, <span class="fu">c</span>(<span class="st">"EASTING"</span>, <span class="st">"NORTHING"</span>)]))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(coordmatrix) <span class="ot">&lt;-</span> coord1400<span class="sc">$</span>Site</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coordmatrix) <span class="ot">&lt;-</span> coord1400<span class="sc">$</span>Site</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Filter matrices for matching site names - make sure everything is honky-dory</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>common_sites <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">rownames</span>(sim1400), <span class="fu">rownames</span>(coordmatrix))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>sim1400 <span class="ot">&lt;-</span> sim1400[common_sites, common_sites]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>coordmatrix <span class="ot">&lt;-</span> coordmatrix[common_sites, common_sites]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#reading filtered work</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim1400)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coordmatrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="louvain-community-detection" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="louvain-community-detection"><span class="header-section-number">6</span> Louvain Community Detection</h2>
<p>This was one of the biggest processes in the project because it required a 100 increment long loop that calculated communities each time. Peeples and Bischoff outline that for their Louvain community detection model they ran it at every percentile from 100% to 1% to see where the prototypical distances, or the representative distance for groups, changed.<br>
</p>
<p>The loop itself required setting up a storage matrix, then creating a binary matrix version of <code>coordmatrix</code> to calculate distance. After that, I combined the <code>distmatrix</code> to <code>sim1400</code> (removing N/As) to have the appropriate filler for the <code>cluster_louvain</code> function from <code>:igraph:</code> which I discovered only works on graphs. This graph had to be undirected and derived from the <code>community</code> matrix.</p>
<p>Matthew Peeples produced an outline of a similar methodology here <a href="https://github.com/mpeeples2008/UniformProbabilityDensityAnalysis" class="uri">https://github.com/mpeeples2008/UniformProbabilityDensityAnalysis</a>. I realized this repository looked really close to what the paper was doing so I tried not to use it, but I did look to it’s section on this method because my loops weren’t working at all. They also revealed that I had to <code>set.seed(63246)</code> to get the thing to produce similar results because <code>cluster_louvain</code> is random without it. Other than this instance where it felt impossible to proceed without their prior work, I ignored this repository to try and tackle this problem on my own.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Louvain community detection</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Setting up result storage</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(sim1400), <span class="dv">100</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Loop through 100 different distance thresholds to generate community partitions</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert coordmatrix to binary matrix based on percentile threshold</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  distmatrix <span class="ot">&lt;-</span> <span class="fu">event2dichot</span>(coordmatrix, <span class="at">method =</span> <span class="st">'quantile'</span>, <span class="at">thresh =</span> <span class="dv">1</span> <span class="sc">-</span> (i <span class="sc">/</span> <span class="dv">100</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#creating the community matrix</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  community <span class="ot">&lt;-</span> distmatrix <span class="sc">*</span> sim1400</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#replace N/A's w/ 0</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  community[<span class="fu">is.na</span>(community)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  community[<span class="fu">is.nan</span>(community)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create weighted graph</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(community, <span class="at">mode =</span> <span class="st">"undirected"</span>, <span class="at">weighted =</span> <span class="cn">TRUE</span>, <span class="at">diag =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Community detection with Louvain algorithm</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">63246</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  res[, i] <span class="ot">&lt;-</span> <span class="fu">cluster_louvain</span>(G, <span class="at">weights =</span> <span class="fu">E</span>(G)<span class="sc">$</span>weight)<span class="sc">$</span>membership</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adjusted-rand-index-for-1400-1450-communities" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="adjusted-rand-index-for-1400-1450-communities"><span class="header-section-number">7</span> Adjusted Rand Index for 1400-1450 Communities</h2>
<p>After running the community matrix, I had to pass it through another loop at each percentile creating an adjusted Rand index. Peeples and Bischoff outline the equation as</p>
<p><code>`R = the number of pairs of items that are in the same community in both partitions&nbsp;X&nbsp;and Y + the number of items that are in different communities in both&nbsp;X&nbsp;and Y / total count of pairs in the relationships considered</code></p>
<p>Luckily, <code>:fossil:</code> has the <code>adj.rand.index()</code> function which does all of that calculation for me, I just needed to run a loop to collate the results and then filter out any NAs.</p>
<p>I also had to set up <code>registerDoParallel()</code> to speed up this process, because this creates a criminally massive list.</p>
<p><strong>WARNING:</strong> This takes a good while to load. I’ll try to upload a saved version alongside the .qmd in the repo but if not, just prepare to waste an hour or so on this.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate Adjusted Rand Index</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#setting up cores</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#creating a rand index with :fossil:</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>rand_index <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="cf">function</span>(n) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    fossil<span class="sc">::</span><span class="fu">adj.rand.index</span>(res[, i], res[, n])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>rand_index[<span class="fu">is.na</span>(rand_index)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#sorting out NAs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prototypical-scales-and-breakpoints" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="prototypical-scales-and-breakpoints"><span class="header-section-number">8</span> Prototypical Scales and Breakpoints</h2>
<p>Finally, with the adjusted Rand index for the community results matrix, I could apply that to get the prototypical scales using the <code>:ecp:</code> package that Peeples and Bischoff cite directly. Importantly, prototypical scales are defined as;</p>
<p><em>“the distance between a pair of identified critical scales that is is most similar to all other distances within the same sub-division.”</em></p>
<p>This means that the numbers saved into <code>pscale</code> represent the average critical scale or geographic distance associated with abrupt change per % of distance considered.</p>
<p>To get these numbers I used the <code>e.agglo()</code> function from the aforementioned <code>:ecp:</code> and then isolated the estimates produced at the general level and the lowest quartile - which Peebles and Bischoff explain is to capture subdivisions better. I then removed the duplicates and combined the scales into a single file. This gets me the scales but not the distances. These scales represent</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#getting protoypical scales using :ecp:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>scale1 <span class="ot">&lt;-</span> <span class="fu">e.agglo</span>(rand_I, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">penalty =</span> <span class="cf">function</span>(cp, Xts)<span class="dv">0</span>) <span class="co"># calculate across all distances</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>scale1a <span class="ot">&lt;-</span> scale1<span class="sc">$</span>estimates <span class="sc">-</span> <span class="dv">1</span> <span class="co">#isolating the estimates</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>scale2 <span class="ot">&lt;-</span> <span class="fu">e.agglo</span>(rand_I[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>], <span class="at">alpha =</span> <span class="fl">1.5</span>, <span class="at">penalty =</span> <span class="cf">function</span>(cp, Xts)<span class="dv">0</span>) <span class="co"># calculate within the lowest quartile as Peebles and Bischoff say to do</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>scale2a <span class="ot">&lt;-</span> scale2<span class="sc">$</span>estimates <span class="sc">-</span> <span class="dv">1</span> <span class="co">#isolating the estimates</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>scale2a <span class="ot">&lt;-</span> scale2a[<span class="sc">-</span><span class="fu">length</span>(scale2a)]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># combine and remove duplicates</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(scale1a, scale2a)))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>scale[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">unique</span>(scale)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Getting the distances requires a loop for each partition or scale of community to see which distance is closest to all the other critical scales in each community at each distance considered.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate prototypical distances for each partition and create data frame</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>proto.typical <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(scale) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  lv <span class="ot">&lt;-</span>  scale[i]<span class="sc">:</span>scale[i <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  proto.typical[i] <span class="ot">&lt;-</span>  lv[<span class="fu">which.max</span>(<span class="fu">rowSums</span>(rand_I[lv, lv]))]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>pscale <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(proto.typical)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pscale) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'X'</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pscale)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="plotting-the-ari-heatmap" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="plotting-the-ari-heatmap"><span class="header-section-number">9</span> Plotting the ARI Heatmap</h2>
<p>Finally, I plot the result using <code>:ggplot:</code> after converting <code>rand_I</code> into a data frame so it can be read properly.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#creating a dataframe for ggplot</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ari_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(rand_I) <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>x, <span class="at">names_to =</span> <span class="st">"y"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">as.integer</span>(x), <span class="at">y =</span> <span class="fu">as.integer</span>(y))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#making the plot</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>ari <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(ari_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">name =</span> <span class="st">"ARI"</span>, <span class="at">option =</span> <span class="st">"D"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> scale <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">col =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> scale <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">col =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> pscale, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> X), <span class="at">size =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Percent of Distance Considered"</span>, <span class="at">y =</span> <span class="st">"Percent of Distance Considered"</span>, <span class="at">title =</span> <span class="st">"1400–1449 CE"</span>) <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">1</span>),</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">#showing the plot</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"images/fig4"</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ari) <span class="co">#this displays that during the final 50year span, there were 6 key prototypical spans</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Comparison with the original</p>
<p><img src="images/fig4.jpg" width="###px"></p>
</section>
<section id="final-review-and-summary-of-results" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="final-review-and-summary-of-results"><span class="header-section-number">10</span> Final Review and Summary of Results</h2>
<p>Looking at the two images in comparison, my results closely follow the results from the original paper with similar placement of prototypical distances - the red dots - and similar community similarity over distance - the gradient.</p>
<p>The big difference between the final statistic and Peeples and Bischoff is the amount of breakpoints on the graph. I seem to be recording MORE division between critical scales than they are, although clustered around broadly similar areas. This may be because they had some way to trim their data or collate the breakpoints to only include the largest gaps; however, they didn’t outline this in their data. Alternatively this could stem from the errors observed in the descriptive statistics described earlier. I do find it interesting that the gradient - a.k.a the distances considered - are largely identical between my replication and the original</p>
<section id="conclusion" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">10.1</span> Conclusion</h3>
<p>In conclusion, I was able to replicate the usefulness of the ceramic ware similarity matrix for the 1400-1449 subset of the originally outlined data. While my results don’t perfectly match the conclusions of the original test, they do imply more partitions - or scales of communities - than Peeples and Bischoff. This could have been due to an error in one of the many dense loops that built up the project or because I failed to apply uniform probability distribution analysis to the original dataset.</p>
<p>I would have liked to have reproduced the more interesting figures and inferential statistics found in the comparison of periods. You’ll have noticed my visual and inferential statistics are kinda combined. As said earlier and in class, this is because of the size of their datasets; I simply didn’t have the time or hardware required to take on the creation of such large matrices. I’m not 100% satisfied with the amount of work I was able to do but I do believe that this was the closest replication I could produce given the restraints. I also believe that the visual above represents important inferential information as well as providing a visual summary.</p>
<p>In summation, while Peeples and Bischoff likely operated with far more elegant loops, more custom functions, and more time/hardware, I was able to replicate their techniques by following their description in text, looking at the figures for comparison, and lots and lots of trial and error.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>